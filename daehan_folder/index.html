<!DOCTYPE html>
<html lang="ko">

<head>
  <meta charset="UTF-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>json-server test</title>
  <link rel="stylesheet" href="css/css.css">
  <style>
    ul {
      list-style-type: none;
      /* 좌측 여백 없애기 */
      padding-left: 0px;
      /* 우측 정렬 하기 */
      text-align: center;
    }

    ul li {
      display: inline;
      /* li요소의 좌측 1px의 테두리 만들기 */
      border-left: 1px solid #c0c0c0;
      /* 테두리와 메뉴 간격 벌리기, padding: 위 오른쪽 아래 왼쪽; */
      padding: 0px 10px 0px 10px;
      /* 메뉴와 테두리 사이 간격 벌리기, margin: 위 오른쪽 아래 왼쪽; */
      margin: 5px 0px 5px 0px;
    }

    ul li:first-child {

      /* li의 첫번째 요소 좌측에는 테두리 없애기 */
      border-left: none;

    }

    .show {
      display: block;
    }

    .hide {
      display: none;
    }
  </style>
</head>

<body onload="getPosts()">
  <nav>
    <ul>
      <li><a href="" id="aRead">조회</a></li>
      <li><a href="" id="aCreate">작성</a></li>
      <li><a href="" id="aUpdate">수정</a></li>
      <li><a href="" id="aDel">삭제</a></li>
    </ul>
  </nav>

  <!-- <button id="read">조회</button> -->

  <div id="cdialog" class="hide">
    <form action="" id="create">
      제목: <input type="text" id="title"> <br />
      저자: <input type="text" id="writer"> <br />
      내용: <input type="text" name="content">
      <button>작성</button>
    </form>
  </div>

  <div id="mdialog" class="hide">
    <form action="" id="modify">
      글id: <input type="text" name="postId"> <br />
      제목: <input type="text" name="title"> <br />
      저자: <input type="text" name="writer">
      <button>수정</button>
    </form>
  </div>

  <div id="ddialog" class="hide">
    <form action="" id="del">
      글id: <input type="text" id="postId">
      <button>삭제</button>
    </form>
  </div>

  <div id="board" class="hide">
    <div class="board_list">
      <div class="top">
        <div class="num">번호</div>
        <div class="title">제목</div>
        <div class="writer">글쓴이</div>
        <div class="date">작성일</div>
        <div class="count">조회</div>
      </div>
    </div>
  </div>

  <div id="boardContent" class="hide">
    <div class="content_list">
      <div class="content_top">
        <div class="content_num">번호</div>
        <div class="content_title">제목</div>
        <div class="content_writer">글쓴이</div>
        <div class="content_date">작성일</div>
        <div class="content_count">조회</div>
      </div>
      <div id="left_view">
        <div class="content"></div>
      </div>
    </div>
  </div>

  <script>
    const $board = document.querySelector('#board');
    const $cdialog = document.querySelector('#cdialog');
    const $mdialog = document.querySelector('#mdialog');
    const $ddialog = document.querySelector('#ddialog');
    const $boardList = document.querySelector(".board_list");
    const $boardContent = document.querySelector("#boardContent");
    const $contentList = document.querySelector(".content_list");
    const $top = document.querySelector(".top");
    const $contentTop = document.querySelector(".content_top");

    let boardData;

    // 게시판 작성/수정/삭제 후 기본 포맷
    function defaultDisplay() {
      $board.className = 'show';
      $cdialog.className = 'hide';
      $mdialog.className = 'hide';
      $ddialog.className = 'hide';
      $boardContent.className = 'hide';
    }

    // 게시판 title 클릭 시 내용 보여주기
    function viewContent(e) {
      $board.className = 'hide';
      $cdialog.className = 'hide';
      $mdialog.className = 'hide';
      $ddialog.className = 'hide';
      $boardContent.className = 'show';

      fetch('http://localhost:3000/posts/' + e.target.parentNode.id)
      .then ((response) => response.json())
      .then ((json) => {
        console.log(json);
        $contentList.innerHTML = '';
        $contentList.appendChild($contentTop);

        const $divTop = document.createElement('div');
        const $divBox = document.createElement('div');

        const divNum = document.createElement('div');
        divNum.className = 'content_num';
        divNum.textContent = `${json.id}`;
        
        const divTitle = document.createElement('div');
        divTitle.className = 'content_title';
        divTitle.id = `${json.id}`;
        divTitle.innerHTML = `<h3>${json.title}</h3>`;

        const divWriter = document.createElement('div');
        divWriter.className = 'content_writer';
        divWriter.textContent = `${json.writer}`;

        const divDate = document.createElement('div');
        divDate.className = 'content_date';
        divDate.textContent = `${json.createdAt}`;

        const divCount = document.createElement('div');
        divCount.className = 'content_count';
        divCount.innerText = `${json.hit}`;

        const $divContent = document.createElement('div');
        $divContent.className = 'content';
        $divContent.textContent = `${json.content}`;
        
        $divTop.append(divNum, divTitle, divWriter, divDate, divCount);
        $divBox.append($divContent);
        $contentList.append($divTop, $divBox);       
      })
    }

    const getPosts = (e) => {
      if (e) e.preventDefault();
      else {
        defaultDisplay();
      }

      fetch('http://localhost:3000/posts') // method 를 get 방법으로 호출함
        .then((response) => response.json()) // 정상적으로 데이터를 받아 왔을 때
        // response.json() => 받아온 데이터를 json 형태로 변환해줌
        .then( // 작동 하는 알고리즘
          (data) => {
            //console.log(data);
            boardData = Array.from(data);
            boardData.sort((a, b) => b.id - a.id);
            console.log(boardData);

            $boardList.innerHTML = '';
            $boardList.appendChild($top);

            boardData.forEach((v, i) => {
              const $divRow = document.createElement('div');

              const $divNum = document.createElement('div');
              $divNum.className = 'num';
              $divNum.textContent = boardData.length - i;

              const $divTitle = document.createElement('div');
              $divTitle.className = 'title';
              $divTitle.id = `${v.id}`;
              $divTitle.innerHTML = `<a href="" class="boardTitle")">${v.title}</a>`;

              const $divWriter = document.createElement('div');
              $divWriter.className = 'writer';
              $divWriter.textContent = `${v.writer}`;

              const $divDate = document.createElement('div');
              $divDate.className = 'date';
              $divDate.textContent = `${v.createdAt}`;

              const $divCount = document.createElement('div');
              $divCount.className = 'count';
              $divCount.innerText = `${v.hit}`;

              $divRow.append($divNum, $divTitle, $divWriter, $divDate, $divCount);
              $boardList.appendChild($divRow);
            });
            const $clickTitles = document.querySelectorAll('.title');
            $clickTitles.forEach(function(title){
              title.addEventListener('click', function(e){
                if(e.target.classList.contains('boardTitle')){
                  e.preventDefault();
                  console.log(e.target.parentNode.id);
                  viewContent(e);
        }
      });
    });
          }
        );
    };

    

    /*     const $read = document.querySelector('#read');
        $read.addEventListener('click', getPosts); */

    //document.querySelector('#aRead').addEventListener('click', getPosts);

    //let selectedMenu = '';
    // 메뉴바
    const showMenu = (e) => {
      e.preventDefault();
      if (e.target.textContent === '작성') {
        $board.className = 'hide';
        $cdialog.className = 'show';
        $mdialog.className = 'hide';
        $ddialog.className = 'hide';
        $boardContent.className = 'hide';
      } else if (e.target.textContent === '수정') {
        $board.className = 'hide';
        $cdialog.className = 'hide';
        $mdialog.className = 'show';
        $ddialog.className = 'hide';
        $boardContent.className = 'hide';
      } else if (e.target.textContent === '삭제') {
        $board.className = 'hide';
        $cdialog.className = 'hide';
        $mdialog.className = 'hide';
        $ddialog.className = 'show';
        $boardContent.className = 'hide';
      } else {
        defaultDisplay();
        getPosts(e);
      }
      //console.log(selectedMenu);
    };
    // 작성
    document.querySelector("#aCreate").addEventListener('click', showMenu);
    // 수정
    document.querySelector("#aUpdate").addEventListener('click', showMenu);
    // 삭제
    document.querySelector("#aDel").addEventListener('click', showMenu);
    // 조회
    document.querySelector("#aRead").addEventListener('click', showMenu);


    // 월과 일이 10 보다 작다면 0을 앞에 붙여서 출력
    function leftPad(value) {
      if(value >= 10){
        return value;
      }

      return `0${value}`;
    }

    // 게시판 작성 일자의 기본포맷을 yyyy.mm.dd 로 지정
    function toStringByFormatting(source, delimiter = '.'){
      const year = source.getFullYear();
      const month = leftPad(source.getMonth() + 1);
      const day = leftPad(source.getDate());

      return [year, month, day].join(delimiter);
    }

    // 게시글 동작
    // 작성 시 동작
    const postData = (e) => {
      e.preventDefault(); // 기본적인 이벤트 제거
      const data = {
        title: e.target.title.value,
        writer: e.target.writer.value,
        content: e.target.content.value,
        createdAt: toStringByFormatting(new Date()), // 작성일을 기본포맷을 변경하여 json형태로 저장
        hit: 0
      };
      //const data = { title: "fetch api111", writer: "john한" };
      fetch("http://localhost:3000/posts", {
        method: "POST",
        body: JSON.stringify(data),
        //body: data,
        headers: headers = {
          "content-type": "application/json;charset=UTF-8"
        },
      }).then((response) => response.json()).then((json) => console.log(json));
      e.target.title.value = '';    // 제목 칸에 쓰여진 내용을 가져옴
      e.target.writer.value = '';   // 작성자 칸에 쓰여진 내용을 가져옴
      e.target.content.value = '';  // 내용 칸에 쓰여진 글을 가져옴
      defaultDisplay();
      getPosts(e);
    };

    const $create = document.querySelector('#create');
    $create.addEventListener('submit', postData);

    // 수정 시 동작
    const patchData = (e) => {
      e.preventDefault();
      const data = { title: e.target.title.value, writer: e.target.writer.value };
      fetch("http://localhost:3000/posts/" + e.target.postId.value, {
        method: "PATCH",
        body: JSON.stringify(data),
        headers: headers = {
          "content-type": "application/json;charset=UTF-8"
        }
      }).then(response => response.json()).then(json => console.log(json));
      e.target.postId.value = '';
      e.target.title.value = '';
      e.target.writer.value = '';
      defaultDisplay();
      getPosts(e);
    }

    const $modify = document.querySelector('#modify');
    $modify.addEventListener('submit', patchData);

    // 삭제 시 동작
    const deleteData = (e) => {
      e.preventDefault();
      fetch(`http://localhost:3000/posts/${e.target.postId.value}`, {
        method: "DELETE"
      }).then(response => response.json()).then(json => console.log(json));
      e.target.postId.value = '';
      defaultDisplay();
      getPosts(e);
    }

    const $del = document.querySelector('#del');
    $del.addEventListener('submit', deleteData);

  </script>
</body>

</html>